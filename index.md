# Using UKDF Qserv instance as FrDF Rubin Science Platform TAP service backend

```{abstract}
In this note, we describe the procedure to set up a Qserv instance hosted remotely as the backend for the Rubin Science Platform (RSP) TAP service hosted at CC-IN2P3. We also present some tests conducted to evaluate the impact on performance linked to this configuration.
```

## Introduction
The Rubin Science Platform (RSP) is a set of web applications providing easy access to Rubin data for interactive analysis. Access to the data is mainly provided by an IVOA Table Access Protocol [1], which provides an interface between the user and the backend catalog database.

The catalog database, in general, is stored on a Qserv instance.
The FrDF RSP currently uses its own Qserv instance, which is deployed on a Kubernetes cluster hosted on local bare-metal machines, and provides access to 4 catalogs with a total of 55TB of data.

We are exploring the possibility to use a Qserv instance deployed outside the CC-IN2P3 as backend for the FrDF RSP TAP service.

## RSP and Qserv

The TAP RSP service can be easily configured to point to a Qserv instance via:

```
 qserv:
      host: "hostname:port"
```

But this configuration is not enough to make the TAP service able to talk with Qserv. TAP also needs to know the Qserv databases' schemas, and this information is provided via a Docker image built by the Qserv admins (who know what Qserv serves) and provided to the TAP service via the following configuration:

```
cadc-tap:
  tapSchema:
    image:
      repository: "image"
      tag: x.y.z
```

With this information, we can then setup an RSP TAP service to talk with any Qserv instance.

| Index | Query                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | # sources | Qserv Chunks | Qserv Time | FrDF | FrDF TOPCAT | UKDF | UKDF TOPCAT | IDF | USDF |
| ----- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------- | ------------ | ---------- | ---- | ----------- | ---- | ----------- | --- | ---- |
| 1     | ```sql<br>SELECT diasrc.ra, diasrc.decl, diasrc.diaObjectId, diasrc.diaSourceId, diasrc.filterName, diasrc.midPointTai,scisql_nanojanskyToAbMag(diasrc.psFlux) AS psAbMag,ccdvis.seeing,ccdvis.visitId FROM dp02_dc2_catalogs.DiaSource AS diasrc JOIN dp02_dc2_catalogs.CcdVisit AS ccdvis ON diasrc.ccdVisitId = ccdvis.ccdVisitId<br>WHERE CONTAINS(POINT('ICRS', diasrc.ra, diasrc.decl), CIRCLE('ICRS', 67.4579, -44.0802, 0.0010))=1<br>AND diasrc.filterName = 'i'```<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | 15        | 1            | 1          | 2    | 2           | 3    | 3           | 2   | 1    |
| 2     | <br>```SELECT objectId, coord_ra, coord_dec, detect_isPrimary, <br>scisql_nanojanskyToAbMag(g_cModelFlux) as gmag, scisql_nanojanskyToAbMag(i_cModelFlux) as imag,<br>scisql_nanojanskyToAbMag(r_cModelFlux) as rmag,<br>scisql_nanojanskyToAbMagSigma(g_cModelFlux, g_cModelFluxErr) as gmag_err,<br>scisql_nanojanskyToAbMagSigma(i_cModelFlux, i_cModelFluxErr) as imag_err,<br>scisql_nanojanskyToAbMagSigma(r_cModelFlux, r_cModelFluxErr) as rmag_err<br>FROM dp02_dc2_catalogs.Object<br>WHERE CONTAINS (POINT('ICRS', coord_ra, coord_dec), CIRCLE('ICRS', 62.0, -37.0, 0.4)) = 1<br>AND detect_isPrimary = 1```                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | 50000     | 6            | 2          | 8    | 14          | 9    | 7           | 6   | 5    |
| 3     | ```SELECT * FROM dp02_dc2_catalogs.Object WHERE CONTAINS(POINT('ICRS', coord_ra, coord_dec),CIRCLE('ICRS', 63.01804167, -32.87422222, 0.027777777777777776))=1```                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | 1519      | 1            | 2          | 17   | 10          | 18   | 11          | 17  | 8    |
| 4     | ```SELECT TOP 200000 coord_ra, coord_dec FROM dp02_dc2_catalogs.Object WHERE CONTAINS(POINT('ICRS', coord_ra, coord_dec), CIRCLE('ICRS', 62, -37, 1)) = 1 AND detect_isPrimary = 1```                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | 200000    | 19           | 6          | 11   |             | 10   |             | 11  | 5    |
| 5     | ```SELECT RADIANS(coord_ra) AS ra_radians, RADIANS(coord_dec) AS dec_radians FROM dp02_dc2_catalogs.Object WHERE CONTAINS(POINT('ICRS', coord_ra, coord_dec), CIRCLE('ICRS', 62, -37, 1)) = 1 AND detect_isPrimary = 1```                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | 200000    | 19           | 5          | 13   |             | 11   |             | 9   | 8    |
| 6     | ```SELECT scisql_nanojanskyToAbMag(g_cModelFlux) AS gmag, scisql_nanojanskyToAbMag(r_cModelFlux) AS rmag, scisql_nanojanskyToAbMag(i_cModelFlux) AS imag FROM dp02_dc2_catalogs.Object WHERE CONTAINS(POINT('ICRS', coord_ra, coord_dec), CIRCLE('ICRS', 62, -37, 1)) = 1 AND detect_isPrimary != 0 AND scisql_nanojanskyToAbMag(i_cModelFlux) <= 25```                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | 200000    | 19           | 5          | 11   |             | 12   |             | 12  | 7    |
| 7     | ```SELECT scisql_nanojanskyToAbMag(g_cModelFlux) AS gmag, scisql_nanojanskyToAbMag(r_cModelFlux) AS rmag, scisql_nanojanskyToAbMag(i_cModelFlux) AS imag FROM dp02_dc2_catalogs.Object WHERE CONTAINS(POINT('ICRS', coord_ra, coord_dec), CIRCLE('ICRS', 62, -37, 1)) = 1 AND detect_isPrimary = 1 AND r_cModelFlux BETWEEN g_cModelFlux AND i_cModelFlux```                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | 500000    | 19           | 8          | 23   | 22          | 24   | 25          | 18  | 12   |
| 8     | ```SELECT objectId, scisql_nanojanskyToAbMag(g_psfFlux) AS gmag, scisql_nanojanskyToAbMag(r_psfFlux) AS rmag, scisql_nanojanskyToAbMag(r_psfFlux) AS imag, scisql_nanojanskyToAbMag(i_psfFlux) AS zmag FROM dp02_dc2_catalogs.Object WHERE objectId IN (1249537790362809267, 1252528461990360512, 1248772530269893180, 1251728017525343554, 1251710425339299404, 1250030371572068167, 1253443255664678173, 1251807182362538413, 1252607626827575504, 1249784080967440401, 1253065023664713612, 1325835101237446771)```                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | 12        | 11           | 1          | 5    | 3           | 3    | 4           | 3   | 1    |
| 9     | ```SELECT scisql_nanojanskyToAbMag(fs.psfFlux) AS mag, scisql_nanojanskyToAbMagSigma(fs.psfFlux, fs.psfFluxErr) AS magerr, cv.band, cv.expMidptMJD FROM dp02_dc2_catalogs.Object AS o JOIN dp02_dc2_catalogs.ForcedSource AS fs ON o.objectId = fs.objectId JOIN dp02_dc2_catalogs.CcdVisit AS cv ON fs.ccdVisitId = cv.ccdVisitId WHERE CONTAINS(POINT('ICRS', o.coord_ra, o.coord_dec), CIRCLE('ICRS', 62.1479031, -35.799138, 0.0006)) = 1 AND o.detect_isPrimary = 1```                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | 432       | 1            | 6          | 9    |             | 9    |             | 3   | 2    |
| 10    | <br>```SELECT mt.id_truth_type AS mt_id_truth_type,mt.match_objectId AS mt_match_objectId,ts.ra AS ts_ra,ts.dec AS ts_dec,ts.truth_type AS ts_truth_type,ts.mag_r AS ts_mag_r,ts.is_pointsource AS ts_is_pointsource,ts.redshift AS ts_redshift,ts.flux_u AS ts_flux_u,ts.flux_g AS ts_flux_g,ts.flux_r AS ts_flux_r,ts.flux_i AS ts_flux_i,ts.flux_z AS ts_flux_z,ts.flux_y AS ts_flux_y,obj.coord_ra AS obj_coord_ra,obj.coord_dec AS obj_coord_dec,obj.refExtendedness AS obj_refExtendedness,scisql_nanojanskyToAbMag(obj.r_cModelFlux) AS obj_cModelMag_r,obj.u_cModelFlux AS obj_u_cModelFlux,obj.g_cModelFlux AS obj_g_cModelFlux,obj.r_cModelFlux AS obj_r_cModelFlux,obj.i_cModelFlux AS obj_i_cModelFlux,obj.z_cModelFlux AS obj_z_cModelFlux,obj.y_cModelFlux AS obj_y_cModelFlux FROM dp02_dc2_catalogs.MatchesTruth AS mt JOIN dp02_dc2_catalogs.TruthSummary AS ts ON mt.id_truth_type=ts.id_truth_type JOIN dp02_dc2_catalogs.Object AS obj ON mt.match_objectId=obj.objectId WHERE scisql_s2PtInCircle(obj.coord_ra,obj.coord_dec,62.0,-37.0,0.1)=1 AND ts.truth_type=1 AND obj.detect_isPrimary=1``` | 14501     | 2            | 136        | 143  | 143         | 159  | 149         | 147 | 84   |
| 11    | ```SELECT id_truth_type, ra, dec, host_galaxy FROM dp02_dc2_catalogs.TruthSummary WHERE id_truth_type = 'MS_9684_23_3'```                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | 1         | 1            | 1          | 2    |             | 2    |             | 2   | 1    |
| 12    | ```SELECT coord_ra, coord_dec FROM dp02_dc2_catalogs.Object WHERE CONTAINS(POINT('ICRS', coord_ra, coord_dec), POLYGON('ICRS',48.57,-44.63,75.24,-44.63,75.24,-26.78,48.57,-26.78 )) = 1 AND r_extendedness = 1 AND detect_isPrimary = 1 AND scisql_nanojanskyToAbMag(r_cModelFlux) < 21.0```                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | 500000    | 1393         | 27         | 71   |             | 79   |             | 482 | 13   |
| 13    | <br>```SELECT fs.forcedSourceId,fs.objectId,fs.ccdVisitId,fs.detect_isPrimary,fs.band,scisql_nanojanskyToAbMag(fs.psfFlux) AS psfMag,ccd.obsStartMJD,scisql_nanojanskyToAbMag(obj.r_psfFlux) AS obj_rpsfMag FROM dp02_dc2_catalogs.ForcedSource AS fs JOIN dp02_dc2_catalogs.CcdVisit AS ccd ON fs.ccdVisitId=ccd.ccdVisitId JOIN dp02_dc2_catalogs.Object AS obj ON fs.objectId=obj.objectId WHERE scisql_s2PtInCircle(obj.coord_ra,obj.coord_dec,62,-37,1.0)=1 AND obj.detect_isPrimary=1 AND obj.r_extendedness=0 AND scisql_nanojanskyToAbMag(obj.r_cModelFlux) > 17.5 AND scisql_nanojanskyToAbMag(obj.r_cModelFlux) < 18.0 AND fs.band='r'```                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | 41751     | 19           | 1          | 5    | 3           | 5    | 5           | 16  | 6    |
| 14    | `# Catalog Queries with the TAP Service` notebook                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |           |              |            | 80   |             | 78   |             | 210 | 49   |


The next plot shows the results for queries executed directly from the RSP Portal service. FrDF_UKDF shows results when the RSP backend is set to the UKDF Qserv instance.

